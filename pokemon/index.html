<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>PKMG</title>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            height: 100%;
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <div style="display:none">
        <select multiple="multiple" id="poke-select"></select>
    </div>

    <!-- javascript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/push.js/0.0.11/push.js"></script>

    <script>
        Notification.requestPermission();
        var pokemons = prompt('Enter Pokemon\'s ID', '130,131,134,135,136,143,144,145,146,148,149,150,151');
        pokemons = pokemons.split(',');
        pokemons = jQuery.map(pokemons, function(v, i){
          return parseInt(v);
        });
        var markers = [];
        var currentPokemonID = -1;

        function initMap() {
            var myLatLng = {
                lat: 10.775406,
                lng: 106.706645
            };
            var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: myLatLng
            });

            map.addListener('idle', function() {
                initializeMarkers(map);

            });
            /*map.addListener('drag', function() {
              initializeMarkers(map);
            });*/
            map.addListener('zoom_changed', function() {
                initializeMarkers(map);
            });
            setInterval(function() {
                initializeMarkers(map);
            }, 30000);
        }

        function initializeMarkers(map) {
            clearMarkers();
            markers = [];
            ajaxUrl = "https://www.pokeradar.io/api/v1/submissions?deviceId=7391cbf065f011e6b4c2d5bb098d395c&minLatitude=" + map.getBounds().getSouthWest().lat() + "&maxLatitude=" + map.getBounds().getNorthEast().lat() + "&minLongitude=" + map.getBounds().getSouthWest().lng() + "&maxLongitude=" + map.getBounds().getNorthEast().lng() + "&pokemonId=0";
            $.get(ajaxUrl, function(data) {

                for (var j = 0; j < data["data"].length; j++) {
                    if (data["data"][j]["trainerName"].indexOf("Prediction") > 0 && pokemons.indexOf(data["data"][j]["pokemonId"]) > -1) {
                        var image = {
                            url: "https://df48mbt4ll5mz.cloudfront.net/images/pokemon/" + data["data"][j]["pokemonId"] + ".png",
                            size: new google.maps.Size(71, 71),
                            origin: new google.maps.Point(0, 0),
                            anchor: new google.maps.Point(17, 34),
                            scaledSize: new google.maps.Size(55, 55)
                        };

                        var marker = new google.maps.Marker({
                            position: {
                                lat: data["data"][j]["latitude"],
                                lng: data["data"][j]["longitude"]
                            },
                            map: map,
                            address: "test",
                            title: data["data"][j]["trainerName"],
                            icon: image
                        });

                        var location = {
                            lat: data["data"][j]["latitude"],
                            lng: data["data"][j]["longitude"]
                        };
                        if (currentPokemonID == -1 || currentPokemonID != data["data"][j]["pokemonId"]) {
                            //currentPokemonID = data["data"][j]["pokemonId"];
                            updateVariable(data["data"][j]["pokemonId"]);
                            Push.create($("a[data-pokemon-id='" + data["data"][j]["pokemonId"] + "']").text(), {
                                body: "Click to Copy LatLng : " + location.lat + ", " + location.lng,
                                icon: image.url,
                                timeout: 900000,
                                onClick: function() {
                                    executeCopy(location.lat + ", " + location.lng);
                                    this.close();
                                }
                            });

                        }
                        var infowindow = new google.maps.InfoWindow({
                            content: "vcl"
                        });
                        marker.addListener('click', function() {
                            infowindow.open(map, marker);
                        });
                        google.maps.event.addListener(marker, 'click', (function(marker, j) {
                            return function() {
                                infowindow.setContent("Pokemon: <b>" + $("a[data-pokemon-id='" + data["data"][j]["pokemonId"] + "']").text() + "</b><br/>Found by trainer: <b>" + data["data"][j]["trainerName"] + "</b><br/>Lat/Long: <b>" + data["data"][j]["latitude"] + "," + data["data"][j]["longitude"] + "</b><br/>Time: <b>" + new Date(data["data"][j]["created"] * 1000).getHours() + ":" + new Date(data["data"][j]["created"] * 1000).getMinutes() + "</b><br/>Helpful: <b>" + (data["data"][j]["upvotes"] / (data["data"][j]["upvotes"] + data["data"][j]["downvotes"])) * 100 + "%</b> (" + (data["data"][j]["downvotes"] + data["data"][j]["upvotes"]) + " votes)");
                                infowindow.setOptions({
                                    maxWidth: 300
                                });
                                infowindow.open(map, marker);
                            }
                        })(marker, j));
                        markers.push(marker);
                    }
                }
            });

        }

        function clearMarkers() {
            setMapOnAll(null);
        }

        function setMapOnAll(map) {
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(map);
            }
        }

        function updateVariable(a) {
            currentPokemonID = a;
        }

        function executeCopy(text) {
            var input = document.createElement('textarea');
            document.body.appendChild(input);
            input.value = text;
            input.focus();
            input.select();
            document.execCommand('Copy');
            input.remove();
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAx6W7C9TsaPwK1aFVdzo1aSBBegq5Av4Y&callback=initMap"></script>
</body>

</html>